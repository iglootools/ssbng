#!/bin/bash
# Generated by nbkp sh — ${{ timestamp }}
${{ config_line }}
#
# Preserved from nbkp run:
#   - All 4 rsync command variants (local→local, local→remote, remote→local, remote→remote)
#   - SSH options (port, key, -o options, proxy jump -J)
#   - Rsync filters and filter-file support
#   - Btrfs: snapshot creation, link-dest incremental backups, pruning
#   - Pre-flight checks: volume markers (.nbkp-vol), endpoint markers (.nbkp-src/.nbkp-dst)
#   - Dry-run and verbose support (as runtime script arguments)
#   - Nonzero exit on any sync failure
#
# Dropped from nbkp run:
#   - Rich console output (spinners, tables, progress bars) → simple log messages
#   - JSON output mode → not applicable for a shell script
#   - Python runtime / config parsing → all values hardcoded
#   - allow-removable-devices flag → checks are inline, comment out if not needed
#   - Paramiko-only SSH options (channel_timeout, disabled_algorithms) → no ssh CLI equivalent

# Unofficial bash strict mode (http://redsymbol.net/articles/unofficial-bash-strict-mode/)
set -euo pipefail
IFS=$'\n\t'
<% if has_script_dir %>

NBKP_SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
<% endif %>

NBKP_DRY_RUN=false
NBKP_VERBOSE=0

# --- Argument parsing ---
while [ $# -gt 0 ]; do
  case "$1" in
    -n|--dry-run) NBKP_DRY_RUN=true; shift;;
    -v) NBKP_VERBOSE=$((NBKP_VERBOSE + 1)); shift;;
    --verbose) NBKP_VERBOSE=$((NBKP_VERBOSE + 1)); shift;;
    *) echo "Unknown option: $1" >&2; exit 1;;
  esac
done

NBKP_FAILURES=0
nbkp_log() {
    if [ "$NBKP_DRY_RUN" = true ]; then
        echo "[nbkp] [dry-run] $*" >&2
    else
        echo "[nbkp] $*" >&2
    fi
}

# --- Volume checks ---
<% for check in volume_checks %>
${{ check }}
<% endfor %>

# --- Sync functions ---
<% for sync in syncs %>
<% if sync.enabled %>

${{ sync.fn_name }}() {
    nbkp_log "Starting sync: ${{ sync.slug }}"

    # Pre-flight checks
${{ sync.preflight | indent(4, first=true) }}

    # Build runtime flags
    NBKP_DRY_RUN_FLAG=""
    if [ "$NBKP_DRY_RUN" = true ]; then NBKP_DRY_RUN_FLAG="--dry-run"; fi
    NBKP_VERBOSE_FLAG=""
    if [ "$NBKP_VERBOSE" -ge 3 ]; then NBKP_VERBOSE_FLAG="-vvv"
    elif [ "$NBKP_VERBOSE" -ge 2 ]; then NBKP_VERBOSE_FLAG="-vv"
    elif [ "$NBKP_VERBOSE" -ge 1 ]; then NBKP_VERBOSE_FLAG="-v"
    fi
<% if sync.has_btrfs %>

    # Link-dest resolution (latest snapshot for incremental backup)
${{ sync.link_dest | indent(4, first=true) }}
<% endif %>

    # Rsync
${{ sync.rsync | indent(4, first=true) }}
<% if sync.has_btrfs %>

    # Btrfs snapshot (skip if dry-run)
${{ sync.snapshot | indent(4, first=true) }}
<% if sync.has_prune %>

    # Prune old snapshots (max: ${{ sync.max_snapshots }})
${{ sync.prune | indent(4, first=true) }}
<% endif %>
<% endif %>

    nbkp_log "Completed sync: ${{ sync.slug }}"
}
<% else %>

# : disabled — ${{ sync.slug }}
${{ sync.disabled_body }}
<% endif %>
<% endfor %>

# --- Run all syncs ---
<% for sync in syncs %>
<% if sync.enabled %>
${{ sync.fn_name }} || NBKP_FAILURES=$((NBKP_FAILURES + 1))
<% else %>
# ${{ sync.fn_name }} || NBKP_FAILURES=$((NBKP_FAILURES + 1))  # disabled
<% endif %>
<% endfor %>

# --- Summary ---
if [ "$NBKP_FAILURES" -gt 0 ]; then
    nbkp_log "$NBKP_FAILURES sync(s) failed"
    exit 1
fi
nbkp_log "All syncs completed successfully"
