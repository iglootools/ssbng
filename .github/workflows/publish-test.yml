name: publish-test

# This workflow is used to test the publish workflow without actually publishing to PyPI. 

# Differences with the publish workflow:
# - It is triggered manually instead of being triggered by the release workflow and/or tags.
# - It publishes to https://test.pypi.org/ instead of https://pypi.org/, 
#   which is a separate instance of the Python Package Index that allows trying distribution tools and processes without affecting the real index
# - It enables verbose: true in the pypa/gh-action-pypi-publish action to get more detailed logs for debugging
# - It uses POETRY_DYNAMIC_VERSIONING_BYPASS to bypass the dynamic versioning and use a static version that is accepted by Test PyPI, 
#   since Test PyPI (and PyPI) reject local versions (+hash) generated by poetry-dynamic-versioning in the absence of tags.
#
# Also keep in mind that OIDC authentication does not work with shared workflows, 
# so the code essentially needs to be duplicated in the `publish.yml` and `publish-test.yml` workflows.

on:
  # The workflow is usually triggered when the release workflow completes, but it can also be re-triggered manually if needed using
  # gh workflow run publish-test.yml --ref <tag>
  # gh run list --workflow publish-test.yml
  workflow_dispatch:
  repository_dispatch:

env:
  MISE_EXPERIMENTAL: true
  # Test PyPI (and PyPI) reject local versions (+hash) generated by poetry-dynamic-versioning in the absence of tags. 
  # So the simplest approach for testing is to override the version with a static one that is accepted by Test PyPI.
  POETRY_DYNAMIC_VERSIONING_BYPASS: "0.0.1.dev0"

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
      - run: mise run ci-build
  pypi-publish:
    name: Upload release to Test PyPI
    runs-on: ubuntu-latest
    environment:
      name: testpypi
      # cosmetic URL displayed in the GitHub UI for the environment, 
      # not to be confused with the repository-url used by the pypa/gh-action-pypi-publish action,
      # which is the actual URL of the repository where the package is published
      url: https://test.pypi.org/p/nbkp/
    permissions:
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing
    steps:
    - uses: actions/checkout@v6
    - uses: jdx/mise-action@v3
    - run: mise run ci-build
    - name: Publish package distributions to Test PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        verbose: true